name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm -r build

      # Deploy kiosk to Static Web Apps
      - name: Build kiosk with prod API URL
        run: cd packages/kiosk && VITE_API_URL=${{ secrets.API_URL }} npx vite build

      - name: Deploy kiosk to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: packages/kiosk/dist
          skip_app_build: true

      # Build and deploy API to Container Apps
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push API image
        run: |
          az acr build \
            --registry ${{ secrets.ACR_NAME }} \
            --image ziggy-api:${{ github.sha }} \
            --image ziggy-api:latest \
            --file packages/api/Dockerfile .

      - name: Deploy API to Container Apps
        run: |
          az containerapp update \
            --name ziggy-api \
            --resource-group ziggy-rg \
            --image ${{ secrets.ACR_NAME }}.azurecr.io/ziggy-api:${{ github.sha }}
